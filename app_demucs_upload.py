import os
import subprocess
import streamlit as st

st.set_page_config(page_title="Demucs éŸ³è¨Šåˆ†é›¢", page_icon="ğŸ§", layout="centered")
st.title("ğŸ§ éŸ³è¨Šåˆ†é›¢å™¨ (Demucs)")
st.markdown("è«‹ä¸Šå‚³ä¸€æ®µéŸ³æ¨‚æª”æ¡ˆï¼ˆmp3 æˆ– wavï¼‰ï¼Œç³»çµ±æœƒä½¿ç”¨ [Demucs](https://github.com/facebookresearch/demucs) è‡ªå‹•åˆ†é›¢äººè²ã€é¼“ã€è²æ–¯èˆ‡ä¼´å¥ã€‚")

uploaded_file = st.file_uploader("ğŸ”¼ ä¸Šå‚³éŸ³è¨Šæª”æ¡ˆ", type=["mp3", "wav"])

if uploaded_file is not None:
    # å„²å­˜ä¸Šå‚³çš„æª”æ¡ˆ
    os.makedirs("uploads", exist_ok=True)
    input_path = os.path.join("uploads", uploaded_file.name)
    with open(input_path, "wb") as f:
        f.write(uploaded_file.read())

    st.success(f"âœ… éŸ³è¨Šå·²ä¸Šå‚³ï¼š{uploaded_file.name}")

    with st.spinner("ğŸª„ Demucs æ­£åœ¨é€²è¡ŒéŸ³æºåˆ†é›¢...ï¼ˆè«‹ç¨å€™ï¼‰"):
        try:
            subprocess.run(["demucs", input_path], check=True)
        except FileNotFoundError:
            st.error("âŒ æ‰¾ä¸åˆ° demucsï¼Œè«‹ç¢ºèªå·²å®‰è£ demucs å¥—ä»¶ã€‚")
            st.stop()
        except subprocess.CalledProcessError as e:
            st.error(f"âŒ åˆ†é›¢å¤±æ•—ï¼š{e}")
            st.stop()

    st.success("ğŸ‰ åˆ†é›¢å®Œæˆï¼ä»¥ä¸‹æ˜¯å„è²éƒ¨æª”æ¡ˆï¼š")

    # æ‰¾å‡ºè¼¸å‡ºè·¯å¾‘
    base_name = os.path.splitext(os.path.basename(input_path))[0]
    output_dir = os.path.join("separated", "htdemucs", base_name)

    for part in ["vocals", "drums", "bass", "other"]:
        path = os.path.join(output_dir, f"{part}.wav")
        if os.path.exists(path):
            st.audio(path, format="audio/wav")
            with open(path, "rb") as f:
                st.download_button(f"ä¸‹è¼‰ {part}.wav", f, file_name=f"{part}.wav")
        else:
            st.warning(f"âš ï¸ æ‰¾ä¸åˆ° {part}.wav")
